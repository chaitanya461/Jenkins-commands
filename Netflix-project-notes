Step 1 Launch an Ubuntu (22.04) T2 Large Instance, create IAM role and attach admin permissions

Step 2 Install Jenkins, Docker and Trivy. Create a Sonarqube Container using Docker.

Step 3 Create a TMDB API Key.

Step 4 Install Prometheus and Grafana On the new Server.

Step 5 Install the Prometheus Plugin and Integrate it with the Prometheus server.

Step 6 Email Integration With Jenkins and Plugin setup. I

Step 7 Install Plugins like JDK, Sonarqube Scanner, Nodejs, and OWASP Dependency Check.

Step 8 Create a Pipeline Project in Jenkins using a Declarative Pipeline

Step 9 Install OWASP Dependency Check Plugins

Step 10 Docker Image Build and Push

Step 11 Deploy the image using Docker

Step 12 Setup AWS EKS with Terraform

Step 13 Access the Netflix app on the Browser.

Step 14 Terminate the AWS EC2 Instances.

--------------------------------------------

Script 1 for Terraform, kubectl, Aws cli

vi script1.sh

#!/bin/bash

#install terraform

sudo apt install wget -y

wget -0- https://apt.releases.hashicorp.com/gpg | sudo gpg-dearmor -o/usr/share/keyrings/hashicorp-archive-

keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release-cs) main" sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt update && sudo apt install terraform

#install Kubectl on Jenkins

sudo apt update

sudo apt install curl -y

curl -LO https://dl.k8s.io/release/$(curl-L-s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl

sudo install o root -g root -m 0755 kubectl /usr/local/bin/kubectl

kubectl version-client

#install Aws cli

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" o "awscliv2.zip"

sudo apt-get install unzip -y

unzip awscliv2.zip

sudo ./aws/install

Step 2 Install Jenkins, Docker and Trivy

Script2 for Java, Jenkins, Docker

vi script2.sh

#!/bin/bash

sudo apt update -y

wget -0 https://packages.adoptium.net/artifactory/api/gpg/key/public tee /etc/apt/keyrings/adoptium.asc echo "deb [signed-by=/etc/apt/keyrings/adoptium.asc] https://packages.adoptium.net/artifactory/deb $(awk -F= /^VERSION_CODENAME/{print$2}' /etc/os-release) main" tee /etc/apt/sources.list.d/adoptium.list

sudo apt update -y

sudo apt install temurin-17-jdk-y

/usr/bin/java --version

curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key sudo tee /usr/share/keyrings/jenkins-keyring.asc

> /dev/null

echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/ sudo tee

/etc/apt/sources.list.d/jenkins.list > /dev/null

sudo apt-get update -y

sudo apt-get install jenkins -y

sudo systemctl start jenkins

#install docker

#Add Docker's official GPG key:

sudo apt-get update

sudo apt-get install ca-certificates curl gnupg -y

sudo install -m 0755-d/etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg-dearmor o /etc/apt/keyrings/docker.gpg

sudo chmod a+r/etc/apt/keyrings/docker.gpg

#Add the repository to Apt sources:

echo

"deb [arch=$(dpkg--print-architecture) signed-by=/etc/apt/keyrings/docker.gpg]

https://download.docker.com/linux/ubuntu \

$(./etc/os-release && echo "$VERSION CODENAME") stable" | \ sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin y

sudo usermod ag docker ubuntu

newgrp docker
----------------------::::::------
http://ip:8080

vi trivy.sh

sudo apt-get install wget apt-transport-https gnupg lsb-release -y

wget -q0https://aquasecurity.github.io/trivy-repo/deb/public.key gpg-dearmor sudo tee

/usr/share/keyrings/trivy.gpg> /dev/null

echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc)

main" sudo tee a /etc/apt/sources.list.d/trivy.list

sudo apt-get update

sudo apt-get install trivy -y
---_-_--------------------------------------
Job 1: EKS Provision

Create a S3 private bucket devsecops-netflix-reyaz

Install terraform plugin

let's find the path to our Terraform (we will use it in the tools section of Terraform)

In EC2 instance run the below command

which terraform

Now Manage Jenkins -> Tools

Terraform --> Name: terraform, uncheck install automatically, install directory /usr/bin/

Now create a new pipeline job for the Eks provision

pipeline {
    agent any
    stages {
        stage('Checkout from Git') {
            steps {
                git branch: 'main', url: 'https://github.com/ReyazShaik/devsecops-netflix.git'
            }
        }
        stage('Terraform version') {
            steps {
                sh 'terraform version' // Fixed typo from terraform-version
            }
        }
        stage('Terraform init') {
            steps {
                dir('EKS TERRAFORM') {
                    sh 'terraform init'
                }
            }
        }
        stage('Terraform validate') {
            steps {
                dir('EKS TERRAFORM') {
                    sh 'terraform validate' // Added quotes around the command
                }
            }
        }
        stage('Terraform plan') {
            steps {
                dir('EKS TERRAFORM') {
                    sh 'terraform plan'
                }
            }
        }
        stage('Terraform apply/destroy') {
            steps {
                // Ensure 'action' is defined elsewhere, e.g., as a parameter or environment variable
                script {
                    dir('EKS_TERRAFORM') {
                        sh 'terraform ${action} --auto-approve'
                    }
                }
            }
        }
    }
}

Run the Pipeline

aws eks list-clusters-region ap-south-1

aws eks update-kubeconfig-region ap-south-1-name EKS_CLUSTER

Now Run sonarqube container:

sudo chmod 777 /var/run/docker.sock

systemctl daemon-reload

systemctl restart docker.service

docker run -d-name sonar p 9000:9000 sonarqube:lts-community

http://IP:9000
-----------------------------

Step 3: Create a TMDB API Key to get the movie data automatically from their database

Next, we will create a TMDB API key

Open a new tab in the Browser and search for TMDB, signup first and login

--> Settings --> API --> Create--> Developer -> Application Name demo, rest bla bla bla

cacc35c61cd76805987aca08d540f24e

-------------------------------
Step 4 Install Prometheus Grafana and Node Exporter On the Ubuntu 24 t2.medium

Launch a new Ubuntu 24 t2.medium for Promo and Grafana

Install Promotheus

lets create a new user called system only for Grafana

vi promo.sh

sudo apt update.

sudo useradd-system-no-create-home-shell /bin/false prometheus

wget https://github.com/prometheus/prometheus/releases/download/v2.47.1/prometheus-2.47.1.linux-

amd64.tar.gz

tar -xvf prometheus-2.47.1.linux-amd64.tar.gz

sudo mkdir -p/data/etc/prometheus

cd prometheus-2.47.1.linux-amd64/

sudo mv prometheus promtool /usr/local/bin/

sudo mv consoles/ console_libraries//etc/prometheus/sudo mv prometheus.yml/etc/prometheus/prometheus.yml

sudo chown -R prometheus: prometheus /etc/prometheus//data/cd

rm -rf prometheus-2.47.1.linux-amd64.tar.gz

prometheus --version

sudo vi /etc/systemd/system/prometheus.service

[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target
StartLimitIntervalSec=500
StartLimitBurst=5

[Service]
User=prometheus
Group=prometheus
Type=simple
Restart=on-failure
RestartSec=5s
ExecStart=/usr/local/bin/prometheus \
--config.file=/etc/prometheus/prometheus.yml \
--storage.tsdb.path=/data \
--web.console.templates=/etc/prometheus/consoles \
--web.console.libraries=/etc/prometheus/console_libraries \
--web.listen-address=0.0.0.0:9090 \
--web.enable-lifecycle

[Install]
WantedBy=multi-user.target

sudo systemctl enable prometheus

sudo systemctl start prometheus.

sudo systemctl status prometheus

journalctl -u prometheus f-no-pager

[to check logs]

http://ip:9090

Install Node Exporter:

vi nodeexp.sh

sudo useradd-system-no-create-home-shell /bin/false node exporter

wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz

tar xvf node_exporter-1.6.1.linux-amd64.tar.gz

sudo mv node_exporter-1.6.1.1inux-amd64/node_exporter /usr/local/bin/

rm -rf node_exporter*

node_exporter --version

sudo vi /etc/systemd/system/node exporter.service

[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target
StartLimitIntervalSec=500
StartLimitBurst=5

[Service]
User=node_exporter
Group=node_exporter
Type=simple
Restart=on-failure
RestartSec=5s
ExecStart=/usr/local/bin/node_exporter \
--collector.logind

[Install]
WantedBy=multi-user.target
---
sudo systemctl enable node_exporter

sudo systemctl start node_exporter

sudo systemctl status node exporter

journalctl -u node_exporter f-no-pager [for any errors]

------------------
Install Grafana

vi Grafana.sh

sudo apt-get install -y apt-transport-https software-properties-common

wget -q0 https://packages.grafana.com/gpg.key sudo apt-key add

echo "deb https://packages.grafana.com/oss/deb stable main" sudo tee -a

/etc/apt/sources.list.d/grafana.list

sudo apt-get update.

sudo apt-get -y install grafana

sudo systemctl enable grafana-server

sudo systemctl start grafana-server

sudo systemctl status grafana-server I

http://13.233.215.35:9100-> node exporter is working

http://13.233.215.35:9090 Promo is working

http://1p:3000 --> Grafana, username: admin, password: admin

------------------------------------------------

Step 5 Install the Prometheus Plugin and Integrate it with the Prometheus server

Goto Manage Jenkins -> Plugins -> Available Plugins -->

Prometheus and install it and restart

To create a static target, you need to add job_name with static_configs

Go to Prometheus server

sudo vi /etc/prometheus/prometheus.yml

- job_name: 'jenkins'
  metrics_path: '/prometheus'
  static_configs:
  - targets: ['<jenkins-ip>:8080']

promtool check config /etc/prometheus/prometheus.yml

sudo systemctl restart Prometheus

