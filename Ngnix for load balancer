FROM nginx:latest
#Remove default config and copy custom nginx.conf  
RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d/
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]



services:
  nginx:
    image: nginx:latest
    container_name: nginx_lb
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
    depends_on:
      - backend1
      - backend2
      - backend3

  backend1:
    image: ghcr.io/benc-uk/python-demoapp:latest
    container_name: backend1
    expose:
      - "5000"

  backend2:
    image: ghcr.io/benc-uk/python-demoapp:latest
    container_name: backend2
    expose:
      - "5000"

  backend3:
    image: ghcr.io/benc-uk/python-demoapp:latest
    container_name: backend3
    expose:
      - "5000"



vi nginx.conf

upstream backend {
        server backend1:5000;
        server backend2:5000;
        server backend3:5000;
}


server {
        listen 80;

         location / {
                 proxy_pass http://backend;
                 proxy_set_header Host $host;
                 proxy_set_header X-Real-IP $remote_addr;
                 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                 proxy_set_header X-Forwarded-Proto $scheme;
         }
 }
